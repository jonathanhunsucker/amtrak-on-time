{{ define "content" }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js" integrity="sha256-H9jAz//QLkDOy/nzE9G4aYijQtkLt9FvGmdUTwBk6gs=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js"></script>
  <script src="/js/core.js"></script>

  {{ $data := getJSON (printf "%s%d%s" "data/train/" .Params.number ".json") }}
  <script type="text/javascript">
    const raw = JSON.parse({{ $data | jsonify }});
    console.log(raw);
  </script>

  <p>‚Üê {{ partial "route/link" $data.route }}</p>
  <h2>{{ $data.name }}</h2>
  <table>
    <tbody>
      <tr>
          <td>Itinerary</td>
          <td>{{ partial "train/itinerary" .Params.number }}</td>
      </tr>
      <tr>
          <td>Data</td>
          <td>{{ $data.stats.valid_records }} valid records found</td>
      </tr>
      <tr>
          <td>Timeliness</td>
          <td>{{ partial "train/timeliness" .Params.number }}</td>
      </tr>
      <tr>
        <td>Disruptions</td>
        <td>{{ $data.stats.service_disruptions }} extreme delays and {{ $data.stats.cancellations }} cancellations</td>
      </tr>
    </tbody>
  </table>

  <h3>Arrival delay over time</h3>
  <script type="text/javascript">
    (function () {
      const container = document.createElement('div');
      document.currentScript.parentNode.insertBefore(container, document.currentScript);
      const canvasElement = document.createElement("canvas");
      container.appendChild(canvasElement);

      const context = canvasElement.getContext("2d");
      const data = {
        // Labels should be Date objects
        labels: Object.keys(raw.records).map((yyyymmdd) => moment(yyyymmdd, 'YYYY-MM-DD').toDate()),
        datasets: [{
          fill: false,
          showLabel: false,
          label: 'Arrival delay',
          data: Object.values(raw.records).map((record) => record.cancelled || record.delay === null ? null : record.delay),
          backgroundColor: Defaults.blue,
          borderColor: Defaults.blue,
          showLine: false,
        }]
      };
      const options = {
        type: 'line',
        data: data,
        options: {
          animation: {
            duration: 0,
          },
          responsive: true,
          legend: {
            display: false,
          },
          scales: {
            xAxes: [{
              type: 'time',
              time: {
                tooltipFormat: 'YYYY-MM-DD',
              },
              scaleLabel: {
                display: true,
                labelString: "Date",
              }
            }],
            yAxes: [{
              scaleLabel: {
                display: true,
              }
            }]
          }
        }
      }
      const chart = new Chart(context, options);
    })();
  </script>

  <h3>Arrival delay distribution</h3>
  {{ partial "train/arrival-delay-distribution" .Params.number }}

  <h3>Trip progress</h3>
  <script type="text/javascript">
    (function () {
      const container = document.createElement('div');
      document.currentScript.parentNode.insertBefore(container, document.currentScript);
      const canvasElement = document.createElement("canvas");
      container.appendChild(canvasElement);

      const context = canvasElement.getContext("2d");

      function dataset(data, color, pointRadius) {
        return {
          fill: false,
          lineTension: 0,
          borderWidth: 1,
          pointRadius: pointRadius !== undefined ? pointRadius : 2,
          label: 'Arrival delay',
          data: data,
          backgroundColor: color,
          borderColor: color,
        };
      }

      function toDate(hmma, days) {
        return moment('2019-01-02 ' + hmma, 'YYYY-MM-DD hmma').add(days, 'days').toDate();
      }

      const datasets = [dataset(Object.values(raw.records)[0].lines.map((line, index) => {
        const time = line.scheduled_departure || line.scheduled_arrival;
        const days = line.scheduled_departure_day || line.scheduled_arrival_day;;
        return {x: toDate(time, days), y: line.stop};
      }), Defaults.red, 0)].concat(Object.entries(raw.records).map(([key, record]) => {
        const data = record.lines.map((line, index) => {
          if (line.actual_departure === null || index === record.lines.length - 1) {
            time = line.actual_arrival;
            days = line.actual_arrival_day;
          } else {
            time = line.actual_departure;
            days = line.actual_departure_day;
          }

          if (!time) {
              return null;
          }

          return {x: toDate(time, days), y: line.stop};
        }).filter((point) => point !== null);

        return dataset(data, Defaults.translucentBlue);
      }));

      const data = {
        datasets: datasets
      };
      const options = {
        type: 'line',
        data: data,
        options: {
          tooltips: {
          //  enabled: false,
          },
          animation: {
            duration: 0,
          },
          responsive: true,
          legend: {
            display: false,
          },
          scales: {
            xAxes: [{
              type: 'time',
              scaleLabel: {
                display: true,
                labelString: "Date",
              }
            }],
            yAxes: [{
              type: 'category',
              labels: Object.values(raw.records).reduce((accumulation, record) => accumulation.concat(record.lines.map((line) => line.stop)), []).reduce(Functional.unique, []),
              scaleLabel: {
                display: true,
              }
            }]
          }
        }
      }
      const chart = new Chart(context, options);
    })();
  </script>
{{ end }}
