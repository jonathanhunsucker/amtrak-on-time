{{ define "content" }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js" integrity="sha256-H9jAz//QLkDOy/nzE9G4aYijQtkLt9FvGmdUTwBk6gs=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js"></script>
  <script type="text/javascript">
    class Defaults {
      static get blue() {
        return 'rgba(0, 0, 255, 0.8)';
      }
      static get translucentBlue() {
        return 'rgba(0, 0, 255, 0.1)';
      }
    }

    class Functional {
      static get unique() {
        return (accumulation, item) => {
          return accumulation.indexOf(item) === -1 ? accumulation.concat(item) : accumulation;
        };
      }
    }
  </script>

  {{ $data := getJSON (printf "%s%d%s" "data/train/" .Params.number ".json") }}
  <script type="text/javascript">
    const raw = JSON.parse({{ $data | jsonify }});
  </script>

  <h2>{{ $data.name }}</h2>
  <table>
    <tbody>
      <tr>
          <td>Route</td>
          <td>{{ partial "route" $data.route }}</td>
      </tr>
      <tr>
          <td>Itinerary</td>
          <td>Departs from {{ partial "stop" $data.origin.stop }} at {{ $data.origin.time }}, bound for {{ partial "stop" $data.destination.stop }} at {{ $data.destination.time }}</td>
      </tr>
      <tr>
          <td>Data</td>
          <td>{{ $data.stats.valid_records }} valid records found ({{ $data.stats.missing_data }} records excluded due to missing data)</td>
      </tr>
      <tr>
          <td>Delay</td>
          <td>{{ $data.stats.median }} minutes typically ({{ $data.stats.cancellations }} cancellations)</td>
      </tr>
    </tbody>
  </table>

  <h3>Arrival delay over time</h3>
  <div id="visualization--arrival-time-scatter"></div>
  <script type="text/javascript">
    (function () {
      const container = document.getElementById("visualization--arrival-time-scatter");
      const canvasElement = document.createElement("canvas");
      container.appendChild(canvasElement);

      const context = canvasElement.getContext("2d");
      const data = {
        // Labels should be Date objects
        labels: Object.keys(raw.records).map((yyyymmdd) => moment(yyyymmdd, 'YYYY-MM-DD').toDate()),
        datasets: [{
          fill: false,
          showLabel: false,
          label: 'Arrival delay',
          data: Object.values(raw.records).map((record) => record.cancelled || record.missing_data ? null : record.delay),
          backgroundColor: Defaults.blue,
          borderColor: Defaults.blue,
          showLine: false,
        }]
      };
      const options = {
        type: 'line',
        data: data,
        options: {
          animation: {
            duration: 0,
          },
          responsive: true,
          legend: {
            display: false,
          },
          scales: {
            xAxes: [{
              type: 'time',
              time: {
                tooltipFormat: 'YYYY-MM-DD',
              },
              scaleLabel: {
                display: true,
                labelString: "Date",
              }
            }],
            yAxes: [{
              scaleLabel: {
                display: true,
              }
            }]
          }
        }
      }
      const chart = new Chart(context, options);
    })();
  </script>

  <h3>Arrival delay distribution</h3>
  <div id="visualization--arrival-time-histogram"></div>
  <script type="text/javascript">
    (function () {
      const container = document.getElementById("visualization--arrival-time-histogram");
      const canvasElement = document.createElement("canvas");
      container.appendChild(canvasElement);

      // array of dates
      var candidates = Object.values(raw.records).filter((record) => !(record.cancelled || record.missing_data));
      var arrivalTimes = candidates.map((entry) => {
        return entry.actual_arrival;
      }).filter((item, index, list) => index === list.indexOf(item));
      var labels = arrivalTimes.map((actual_arrival) => {
        return moment('1970-01-01 ' + actual_arrival, 'YYYY-MM-DD hmma').toDate();
      });

      const data = {
				labels: labels,
				datasets: [{
					label: 'Trains',
					data: arrivalTimes.map((time) => candidates.filter((candidate) => candidate.actual_arrival === time).length),
          backgroundColor: Defaults.blue,
          borderColor: Defaults.blue,
        }]
			};

      var config = {
        type: 'bar',
        data: data,
        options: {
          animation: {
            duration: 0,
          },
          legend: {
            display: false,
          },
          scales: {
            xAxes: [{
              type: 'time',
              barPercentage: .5,
              display: true,
              time: {
                tooltipFormat: 'HH:mm',
              }
            }],
          },
        }
      };

      const chart = new Chart(canvasElement.getContext("2d"), config);
    })();
  </script>

  <h3>Trip progress</h3>
  <div id="visualization--trip-progress"></div>
  <script type="text/javascript">
    (function () {
      const container = document.getElementById("visualization--trip-progress");
      const canvasElement = document.createElement("canvas");
      container.appendChild(canvasElement);

      const context = canvasElement.getContext("2d");

      const datasets = Object.entries(raw.records).map(([key, record]) => {
        return {
          fill: false,
          lineTension: 0,
          showLabel: false,
          label: 'Arrival delay',
          data: record.lines.map((line, index) => {
            if (line.missing_data) {
              return null;
            }

            var time = line.actual_departure || line.actual_arrival;
            
            if (index === record.lines.length - 1) {
              time = line.actual_arrival;
            }

            return {x: moment('2019-01-02 ' + time, 'YYYY-MM-DD hmma').toDate(), y: line.stop};
          }).filter((point) => point !== null),
          backgroundColor: Defaults.translucentBlue,
          borderColor: Defaults.translucentBlue,
        };
      });

      const data = {
        // Labels should be Date objects
        labels: [
          moment('2019-01-02 600a', 'YYYY-MM-DD hmma').toDate(),
          moment('2019-01-02 610a', 'YYYY-MM-DD hmma').toDate(),
          moment('2019-01-02 640a', 'YYYY-MM-DD hmma').toDate(),
          moment('2019-01-02 830a', 'YYYY-MM-DD hmma').toDate(),
        ],
        datasets: datasets
      };
      const options = {
        type: 'line',
        data: data,
        options: {
          animation: {
            duration: 0,
          },
          responsive: true,
          legend: {
            display: false,
          },
          scales: {
            xAxes: [{
              type: 'time',
              scaleLabel: {
                display: true,
                labelString: "Date",
              }
            }],
            yAxes: [{
              type: 'category',
              labels: Object.values(raw.records).reduce((accumulation, record) => accumulation.concat(record.lines.map((line) => line.stop)), []).reduce(Functional.unique, []),
              scaleLabel: {
                display: true,
              }
            }]
          }
        }
      }
      const chart = new Chart(context, options);
    })();
  </script>
{{ end }}
