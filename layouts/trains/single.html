{{ define "content" }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js" integrity="sha256-H9jAz//QLkDOy/nzE9G4aYijQtkLt9FvGmdUTwBk6gs=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js"></script>

  {{ $data := getJSON (printf "%s%d%s" "data/train/" .Params.number ".json") }}
  <h2>{{ $data.name }}</h2>
  <p>Itinerary: Departs from {{ partial "stop" $data.origin.stop }} at {{ $data.origin.time }}, bound for {{ partial "stop" $data.destination.stop }} at {{ $data.destination.time }}</p>
  <p>Route: {{ partial "route" $data.route }}</p>
  <p>Data: {{ $data.stats.valid_records }} valid records found ({{ $data.stats.missing_data }} records excluded due to missing data)</p>
  <p>Stats: median delay of {{ $data.stats.median }} minutes ({{ $data.stats.cancellations }} cancellations)</p>
  <div id="visualization--arrival-time-histogram"></div>
  <p>
    {{ range $key, $value := $data.records }}
      <h3>{{ $key }}</h3>
      <pre>{{ $value }}</pre>
    {{ end }}
  </p>

  <script type="text/javascript">
    const container = document.getElementById("visualization--arrival-time-histogram");
    const canvasElement = document.createElement("canvas");
    container.appendChild(canvasElement);

    const raw = JSON.parse({{ $data | jsonify }});

    const context = canvasElement.getContext("2d");
    const data = {
      // Labels should be Date objects
      labels: Object.keys(raw.records).map((yyyymmdd) => moment(yyyymmdd, 'YYYY-MM-DD').toDate()),
      datasets: [{
        fill: false,
        label: 'Arrival delay',
        data: Object.values(raw.records).map((record) => record.cancelled || record.missing_data ? null : record.delay),
        showLine: false,
      }]
    }
    const options = {
      type: 'line',
      data: data,
      options: {
        fill: false,
        responsive: true,
        scales: {
          xAxes: [{
            type: 'time',
            time: {
              tooltipFormat: 'YYYY-MM-DD'
            },
            scaleLabel: {
              display: true,
              labelString: "Date",
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
            }
          }]
        }
      }
    }
const chart = new Chart(context, options);
  </script>
{{ end }}
